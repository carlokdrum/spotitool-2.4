{% extends "base.html" %}

{% block content %}
<div class="h-full flex flex-col p-4 md:p-8 overflow-hidden w-full max-w-7xl mx-auto">
    <!-- Premium Header -->
    <header
        class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-end gap-4 p-6 glass rounded-[2rem] relative overflow-hidden shrink-0">
        <div class="relative z-10">
            <h2 class="text-3xl md:text-4xl font-black tracking-tighter mb-1">Mis Playlist</h2>
            <p class="text-gray-500 font-medium text-sm">Control total sobre tus creaciones maestras de Spotify.</p>
        </div>
        <div class="relative z-10 bg-white/5 px-4 py-2 rounded-2xl border border-white/5 backdrop-blur-md">
            <div class="text-[9px] font-black uppercase tracking-widest text-gray-500 mb-0.5">Total Generado</div>
            <div class="text-xl font-black text-green-500">{{ history|length }} <span
                    class="text-[10px] text-gray-600 font-bold uppercase tracking-widest">Playlists</span></div>
        </div>

        <!-- Decoration -->
        <div class="absolute -left-20 -bottom-20 w-64 h-64 bg-green-500/5 blur-[100px] rounded-full"></div>
    </header>

    <div class="flex-1 overflow-y-auto custom-scrollbar pr-2">

        {% if history %}
        <div class="grid gap-4">
            {% for item in history %}
            {% set p_url = item.playlist_url or item.url or '' %}
            {% set p_id = item.id or (p_url.split('/')[-1].split('?')[0] if p_url else 'unknown') %}
            <div id="history-entry-{{ p_id }}"
                class="glass-dark border border-white/5 rounded-[2rem] p-6 flex flex-col md:flex-row items-center justify-between hover:bg-white/5 transition-all duration-500 group relative">

                <div class="flex items-center gap-6 w-full md:w-auto">
                    <a href="/playlist/{{ p_id }}" class="flex items-center gap-6 group/item min-w-0">
                        <div
                            class="h-16 w-16 bg-neutral-800 rounded-2xl flex items-center justify-center text-3xl shadow-2xl transition-transform group-hover/item:scale-110 duration-500 relative overflow-hidden">
                            ðŸŽµ
                            <div
                                class="absolute inset-0 bg-green-500 opacity-0 group-hover/item:opacity-20 transition-opacity">
                            </div>
                        </div>
                        <div class="min-w-0">
                            <h3
                                class="font-black text-white text-xl tracking-tight group-hover/item:text-green-500 transition-colors truncate mb-1">
                                {{ item.name }}</h3>
                            <div class="flex items-center gap-4">
                                <div
                                    class="flex items-center gap-1.5 text-[10px] font-black uppercase tracking-widest text-gray-500">
                                    <span class="text-xs">ðŸ“…</span> {{ item.date or 'Hoy' }}
                                </div>
                                <span class="text-gray-800">â€¢</span>
                                <div
                                    class="flex items-center gap-1.5 text-[10px] font-black uppercase tracking-widest text-green-500/60">
                                    <span class="text-xs">ðŸ’¿</span> {{ item.total_added or item.tracks }} Canciones
                                </div>
                            </div>
                        </div>
                    </a>
                </div>

                <div class="flex items-center gap-4 mt-6 md:mt-0 w-full md:w-auto justify-end">
                    <a href="/playlist/{{ p_id }}/edit"
                        class="flex-1 md:flex-none text-center bg-white/5 hover:bg-green-500 hover:text-black text-white px-8 py-3 rounded-2xl font-black text-[10px] uppercase tracking-widest transition-all">
                        Editar / Analizar
                    </a>
                    <a href="{{ p_url }}" target="_blank"
                        class="flex-1 md:flex-none text-center premium-btn text-black px-8 py-3 rounded-2xl font-black text-[10px] uppercase tracking-widest transition-all">
                        Spotify â†—
                    </a>
                    <button onclick="deleteHistoryPlaylist('{{ p_id }}', '{{ p_url }}')"
                        class="p-4 text-gray-700 hover:text-red-500 transition-colors group/del"
                        title="Eliminar definitivamente">
                        <svg class="w-5 h-5 group-hover/del:scale-110 transition-transform" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Custom Danger Modal -->
        <div id="delete-modal" class="fixed inset-0 z-[200] hidden">
            <!-- Backdrop -->
            <div class="absolute inset-0 bg-black/90 backdrop-blur-xl transition-all duration-500"
                onclick="closeDeleteModal()"></div>

            <!-- Modal Card -->
            <div class="absolute inset-0 flex items-center justify-center p-4">
                <div
                    class="bg-[#121212] border border-red-500/20 w-full max-w-sm rounded-[2rem] relative shadow-[0_0_50px_rgba(220,38,38,0.2)] flex flex-col overflow-hidden animate-in zoom-in-95 duration-200">

                    <div class="p-8 text-center">
                        <!-- Icon -->
                        <div
                            class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-6 border border-red-500/20 shadow-[0_0_20px_rgba(220,38,38,0.2)]">
                            <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                </path>
                            </svg>
                        </div>

                        <h3 class="text-xl font-black text-white mb-2">Â¿Eliminar Playlist?</h3>
                        <p class="text-gray-400 text-sm leading-relaxed font-medium">Esta acciÃ³n eliminarÃ¡ la playlist
                            de tu historial y de tu cuenta de Spotify. <br><span class="text-red-400 font-bold">No se
                                puede deshacer.</span></p>
                    </div>

                    <!-- Footer Actions -->
                    <div class="bg-white/5 p-4 flex flex-col gap-3">
                        <button onclick="confirmDelete()"
                            class="w-full bg-red-600 hover:bg-red-500 text-white font-black text-xs uppercase tracking-widest py-4 rounded-xl transition-all hover:scale-[1.02] active:scale-[0.98] shadow-lg flex items-center justify-center gap-2">
                            SÃ­, Eliminar Definitivamente
                        </button>

                        <button onclick="closeDeleteModal()"
                            class="w-full bg-transparent hover:bg-white/5 text-gray-500 hover:text-white font-bold text-[10px] uppercase tracking-widest py-3 rounded-xl transition-colors">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let pendingDeleteId = null;
            let pendingDeleteUrl = null;

            function deleteHistoryPlaylist(playlistId, playlistUrl) {
                pendingDeleteId = playlistId;
                pendingDeleteUrl = playlistUrl;
                document.getElementById('delete-modal').classList.remove('hidden');
            }

            function closeDeleteModal() {
                document.getElementById('delete-modal').classList.add('hidden');
                pendingDeleteId = null;
                pendingDeleteUrl = null;
            }

            async function confirmDelete() {
                if (!pendingDeleteId) return;

                const modal = document.getElementById('delete-modal');
                const entry = document.getElementById('history-entry-' + pendingDeleteId);

                // Hide modal immediately
                modal.classList.add('hidden');

                if (entry) {
                    entry.style.opacity = '0.5';
                    entry.style.pointerEvents = 'none';
                }

                try {
                    const formData = new FormData();
                    formData.append('playlist_id', pendingDeleteId);
                    formData.append('playlist_url', pendingDeleteUrl);

                    const response = await fetch('/history/delete', {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });

                    const data = await response.json();

                    if (data.success) {
                        if (entry) {
                            entry.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                            entry.style.transform = 'translateX(100px) scale(0.9)';
                            entry.style.opacity = '0';
                            setTimeout(() => entry.remove(), 600);
                        }
                        showToast('Playlist eliminada con Ã©xito', 'success');
                    } else {
                        alert('Error: ' + data.error);
                        if (entry) {
                            entry.style.opacity = '1';
                            entry.style.pointerEvents = 'auto';
                        }
                    }
                } catch (err) {
                    console.error(err);
                    alert('Error de conexiÃ³n');
                    if (entry) {
                        entry.style.opacity = '1';
                        entry.style.pointerEvents = 'auto';
                    }
                }
            }
        </script>
        {% else %}
        <div class="glass p-20 text-center rounded-[3rem]">
            <div class="text-6xl mb-6 opacity-20">âŒ›</div>
            <h3 class="text-2xl font-black mb-2 tracking-tight text-white">Tu archivo estÃ¡ vacÃ­o</h3>
            <p class="text-gray-500 font-medium mb-8">Comienza a crear ahora para ver tu historial aquÃ­.</p>
            <a href="/"
                class="premium-btn text-black px-10 py-4 rounded-2xl font-black text-xs uppercase tracking-widest inline-block transition-transform hover:scale-105">
                Generar Primera Playlist
            </a>
        </div>
        {% endif %}
    </div>
    {% endblock %}